<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>üíé Esfera Musical</title>
<style>
body{
  margin:0;background:#050010;color:#fff;font-family:'Poppins',sans-serif;
  display:flex;flex-direction:column;align-items:center;overflow-x:hidden;
}
h2{margin:20px 0 10px;color:#ff66cc;text-shadow:0 0 18px #ff33aa;}
p{width:90%;text-align:center;color:#ccc;margin:0 0 20px;max-width:600px;}
.formulario{
  width:80%;
  max-width:640px;
  padding:20px;
  background:#0a0016;
  border:2px solid #ff33aa;
  border-radius:18px;
  box-shadow:0 0 25px #ff33aa55;
  display:flex;
  flex-direction:column;
  gap:12px;
  margin-bottom:24px;
}

label{font-weight:600;}
input[type=file]{padding:10px;border:1px solid #ff66cc;border-radius:8px;background:#1a001f;color:#fff;}
button{
  background:#ff3399;color:#fff;border:none;border-radius:10px;
  padding:12px 20px;font-weight:600;cursor:pointer;transition:.3s;
}
button:hover{background:#ff00cc;transform:scale(1.05);}
#preview-container {
  width: 90%;
  max-width: 900px;
  height: 80vh; /* ocupa el 80% del alto de pantalla */
  border: 2px solid #ff33aa;
  border-radius: 20px;
  overflow: hidden;
  box-shadow: 0 0 30px #ff33aa88;
}
iframe{width:100%;height:100%;border:none;background:#000;}
</style>
</head>
<body>
  <br>
<h2>üíé ESFERA MUSICAL</h2>
<p>Sube una imagen y una canci√≥n üéµ para crear una esfera de cristal viva que vibra, gira y respira con la m√∫sica.</p>

<div class="formulario">
  <label>üì∏ Imagen:</label>
  <input type="file" id="imagen" accept="image/*">
  <label>üéµ M√∫sica (MP3):</label>
  <input type="file" id="musica" accept="audio/*">
  <button id="btn-preview">üëÄ Ver mi Esfera</button>
  <button id="btn-descargar">üì• Generar Esfera Musical</button>
</div>

<div id="preview-container">
  <iframe id="preview"></iframe>
</div>

<script>
let base64Image="", base64Audio="";
document.getElementById("imagen").addEventListener("change",e=>{
  const f=e.target.files[0]; if(!f) return;
  const r=new FileReader(); r.onload=()=>base64Image=r.result; r.readAsDataURL(f);
});
document.getElementById("musica").addEventListener("change",e=>{
  const f=e.target.files[0]; if(!f) return;
  const r=new FileReader(); r.onload=()=>base64Audio=r.result; r.readAsDataURL(f);
});

function buildHTML(img64,audio64){
return `<!DOCTYPE html>
<html lang="es"><head><meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>ESFERA MUSICAL</title>
<style>
html,body{margin:0;height:100%;background:#080014;overflow:hidden;}
canvas{display:block;}
.player{
  position:fixed;bottom:15px;left:50%;transform:translateX(-50%);
  width:90%;max-width:600px;background:rgba(0,0,0,.75);
  border:1px solid #ff33aa;border-radius:18px;padding:10px 14px;
  box-shadow:0 0 20px #ff33aa;color:#fff;font-family:Arial,sans-serif;
  display:flex;align-items:center;gap:12px;z-index:9999;
}
.player button{font-size:24px;background:none;border:none;color:#fff;cursor:pointer;}
.progress{flex:1;height:8px;border-radius:10px;background:#333;overflow:hidden;}
.progress-bar{width:0%;height:100%;background:linear-gradient(90deg,#ff33aa,#ff6600);}
#time{font-size:14px;}

</style></head>
<body>
<canvas id="c"></canvas>

<div class="player">
  <button id="play">‚ñ∂Ô∏è</button>
  <div class="progress" id="progress"><div class="progress-bar" id="progress-bar"></div></div>
  <div id="time">0:00 / 0:00</div>
</div>
<audio id="audio" loop crossorigin="anonymous"><source src="${audio64}" type="audio/mpeg"></audio>
<script src="https://cdn.jsdelivr.net/npm/three@0.148.0/build/three.min.js"><\/script>
<script>
// === ESCENA ===
const scene=new THREE.Scene();
scene.fog=new THREE.FogExp2(0x080014,0.00045);
const camera=new THREE.PerspectiveCamera(60,innerWidth/innerHeight,0.1,5000);
const renderer=new THREE.WebGLRenderer({canvas:document.getElementById('c'),antialias:true});
renderer.setPixelRatio(Math.min(window.devicePixelRatio,2));
renderer.setSize(innerWidth,innerHeight);
renderer.setClearColor(0x080014,1);
window.addEventListener('resize',()=>{renderer.setSize(innerWidth,innerHeight);camera.aspect=innerWidth/innerHeight;camera.updateProjectionMatrix();});

let camDist=1300, rotX=0.25, rotY=0;
const group=new THREE.Group();scene.add(group);

// üå´Ô∏è Nebulosa envolvente
function makeNebula(size,inner,outer){
  const c=document.createElement('canvas');c.width=c.height=size;
  const g=c.getContext('2d');
  const grd=g.createRadialGradient(size/2,size/2,0,size/2,size/2,size/2);
  grd.addColorStop(0,'rgba('+inner+',.7)');
  grd.addColorStop(1,'rgba('+outer+',0)');
  g.fillStyle=grd;g.fillRect(0,0,size,size);
  return new THREE.CanvasTexture(c);
}
const nebula=new THREE.Sprite(new THREE.SpriteMaterial({
  map:makeNebula(1024,'255,100,255','0,0,0'),
  transparent:true,blending:THREE.AdditiveBlending
}));
nebula.scale.set(5000,5000,1);
scene.add(nebula);

// üíé Esfera de cristal
const glass=new THREE.Mesh(
  new THREE.SphereGeometry(430,64,64),
  new THREE.MeshPhysicalMaterial({
    transmission:1,thickness:14,roughness:0.1,metalness:0.1,reflectivity:1.2,
    clearcoat:1,clearcoatRoughness:0.05,ior:1.4,envMapIntensity:2
  })
);
group.add(glass);

// üí° Luz ambiental
const light=new THREE.PointLight(0xff66cc,1.2,3000);
light.position.set(500,500,800);
scene.add(light);

// üñºÔ∏è Imagen interior
let photo=null;
if("${img64}".startsWith("data:image")){
  const img=new Image();img.src="${img64}";
  img.onload=()=>{
    const tex=new THREE.Texture(img);
    tex.needsUpdate=true;
    tex.encoding=THREE.sRGBEncoding;
    tex.anisotropy=renderer.capabilities.getMaxAnisotropy();
    const mat=new THREE.MeshBasicMaterial({map:tex,side:THREE.DoubleSide,toneMapped:false,fog:false});
    photo=new THREE.Mesh(new THREE.PlaneGeometry(760,410),mat);
    group.add(photo);
  }
}

// üí´ Halo ne√≥n din√°mico
const haloGeo=new THREE.RingGeometry(430,620,256);
const haloMat=new THREE.MeshBasicMaterial({
  color:0xa066ff,transparent:true,opacity:0.4,
  blending:THREE.AdditiveBlending,side:THREE.DoubleSide,depthWrite:false,depthTest:false
});
const halo=new THREE.Mesh(haloGeo,haloMat);
const haloGroup=new THREE.Group();haloGroup.add(halo);group.add(haloGroup);

// üåå Part√≠culas
const orbGeo=new THREE.SphereGeometry(3,8,8);
const orbMat=new THREE.MeshBasicMaterial({color:0xff99ff,transparent:true,opacity:0.8,blending:THREE.AdditiveBlending});
const orbitParticles=[];
for(let i=0;i<120;i++){
  const orb=new THREE.Mesh(orbGeo,orbMat);
  const angle=Math.random()*Math.PI*2;
  const radius=500+Math.random()*150;
  orb.userData={angle,speed:0.001+Math.random()*0.002,radius};
  orb.position.set(Math.cos(angle)*radius,Math.sin(angle*2)*40,Math.sin(angle)*radius);
  group.add(orb);orbitParticles.push(orb);
}

// üå† Estrellas
const starsGeo=new THREE.BufferGeometry();
const count=1600;const pos=new Float32Array(count*3);
for(let i=0;i<count;i++){
  const r=1800*Math.random()+800;const th=Math.random()*Math.PI*2;const ph=Math.acos(2*Math.random()-1);
  pos[i*3]=r*Math.sin(ph)*Math.cos(th);
  pos[i*3+1]=r*Math.cos(ph);
  pos[i*3+2]=r*Math.sin(ph)*Math.sin(th);
}
starsGeo.setAttribute('position',new THREE.BufferAttribute(pos,3));
const stars=new THREE.Points(starsGeo,new THREE.PointsMaterial({color:0xffffff,size:4,opacity:0.8,transparent:true}));
scene.add(stars);

// üîä Audio
const audio=document.getElementById('audio');
const ctx=new (window.AudioContext||window.webkitAudioContext)();
const src=ctx.createMediaElementSource(audio);
const analyser=ctx.createAnalyser();
analyser.fftSize=256;src.connect(analyser);analyser.connect(ctx.destination);
const data=new Uint8Array(analyser.frequencyBinCount);
document.body.addEventListener('touchstart',()=>{if(ctx.state==='suspended')ctx.resume();},{once:true});

// üéÆ Control de c√°mara libre (PC + m√≥vil)
const canvas=renderer.domElement;
canvas.style.touchAction="none";canvas.style.userSelect="none";

let drag=false,lx=0,ly=0,isTouching=false,touchStartX=0,touchStartY=0;
let lastPinchDist=null;

// PC
canvas.addEventListener("mousedown",e=>{drag=true;lx=e.clientX;ly=e.clientY;});
window.addEventListener("mouseup",()=>drag=false);
window.addEventListener("mousemove",e=>{
  if(!drag)return;
  rotY-=(e.clientX-lx)/innerWidth*3;
  rotX-=(e.clientY-ly)/innerHeight*2;
  lx=e.clientX;ly=e.clientY;
});
canvas.addEventListener("wheel",e=>{
  e.preventDefault();
  camDist+=e.deltaY*0.3;
  camDist=Math.max(200,Math.min(12000,camDist));
},{passive:false});

// M√ìVIL
canvas.addEventListener("touchstart",e=>{
  if(e.touches.length===1){isTouching=true;touchStartX=e.touches[0].clientX;touchStartY=e.touches[0].clientY;}
  else if(e.touches.length===2){
    isTouching=false;
    const dx=e.touches[0].clientX-e.touches[1].clientX;
    const dy=e.touches[0].clientY-e.touches[1].clientY;
    lastPinchDist=Math.sqrt(dx*dx+dy*dy);
  }
},{passive:true});

canvas.addEventListener("touchmove",e=>{
  if(isTouching&&e.touches.length===1){
    const dx=e.touches[0].clientX-touchStartX;
    const dy=e.touches[0].clientY-touchStartY;
    rotY-=dx/innerWidth*3;
    rotX-=dy/innerHeight*2;
    touchStartX=e.touches[0].clientX;
    touchStartY=e.touches[0].clientY;
  } else if(e.touches.length===2&&lastPinchDist){
    const dx=e.touches[0].clientX-e.touches[1].clientX;
    const dy=e.touches[0].clientY-e.touches[1].clientY;
    const newDist=Math.sqrt(dx*dx+dy*dy);
    camDist+=(lastPinchDist-newDist)*1.2;
  if (camDist < 10) camDist = 10; // solo evita que entres dentro de la esfera

    lastPinchDist=newDist;
  }
},{passive:true});

canvas.addEventListener("touchend",()=>{isTouching=false;lastPinchDist=null;});

// üé¨ Animaci√≥n
function anim(){
  requestAnimationFrame(anim);
  analyser.getByteFrequencyData(data);
  const bass=data.slice(0,40).reduce((a,b)=>a+b,0)/40;
  const intensity=bass/255;

  nebula.scale.set(5000+intensity*1200,5000+intensity*1200,1);
  nebula.material.opacity=0.4+intensity*0.6;
  halo.material.opacity=0.35+intensity*0.45;
  halo.scale.set(1+intensity*0.25,1+intensity*0.25,1);
  halo.material.color.setHSL((0.85-intensity*0.3),1,0.6);
  glass.scale.set(1+intensity*0.08,1+intensity*0.08,1+intensity*0.08);

  haloGroup.lookAt(camera.position);
  orbitParticles.forEach(p=>{
    p.userData.angle+=p.userData.speed*(1+intensity*3);
    const r=p.userData.radius+Math.sin(Date.now()*0.001+p.userData.angle)*40*intensity;
    p.position.set(Math.cos(p.userData.angle)*r,Math.sin(p.userData.angle*2)*60,Math.sin(p.userData.angle)*r);
    p.material.opacity=0.5+intensity*0.5;
  });
  if(photo){
    const vel=0.0015+(intensity*0.005);
    photo.rotation.y+=vel;
    photo.rotation.x=Math.sin(Date.now()*0.0003)*0.05;
  }
  stars.rotation.y+=0.0003;

  // C√°mara libre
  const cx=Math.cos(rotX),sx=Math.sin(rotX),cy=Math.cos(rotY),sy=Math.sin(rotY);
  camera.position.set(camDist*sy*cx,camDist*sx,camDist*cy*cx);
  camera.lookAt(0,0,0);
  renderer.render(scene,camera);
}
anim();

// üéß Reproductor
const play=document.getElementById('play');
const bar=document.getElementById('progress-bar');
const time=document.getElementById('time');
let playing=false;
function fmt(s){if(!isFinite(s))return'0:00';const m=Math.floor(s/60);const ss=Math.floor(s%60).toString().padStart(2,'0');return m+':'+ss;}
play.addEventListener('click',async()=>{
  if(playing){audio.pause();play.textContent='‚ñ∂Ô∏è';}
  else{await ctx.resume();await audio.play();play.textContent='‚è∏Ô∏è';}
  playing=!playing;
});
audio.addEventListener('timeupdate',()=>{
  const p=(audio.currentTime/audio.duration)*100;
  bar.style.width=(isFinite(p)?p:0)+'%';
  time.textContent=fmt(audio.currentTime)+' / '+fmt(audio.duration);
});
document.getElementById('progress').addEventListener('click',e=>{
  const r=e.target.getBoundingClientRect();
  const p=(e.clientX-r.left)/r.width;
  if(isFinite(audio.duration))audio.currentTime=p*audio.duration;
});
<\/script></body></html>`;
}

// üß© Botones
document.getElementById('btn-preview').addEventListener('click',()=>{
  document.getElementById('preview').srcdoc=buildHTML(base64Image,base64Audio);
});
document.getElementById('btn-descargar').addEventListener('click',()=>{
  const html=buildHTML(base64Image,base64Audio);
  const blob=new Blob([html],{type:'text/html'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a');
  a.href=url;a.download='esfera_cristal_infinity_v9.5.html';
  a.click();URL.revokeObjectURL(url);
});
document.getElementById('preview').srcdoc="<html><body style='margin:0;background:#000;color:#fff;display:flex;align-items:center;justify-content:center;height:100vh;font-family:sans-serif'></body></html>";
</script>
</body>
</html>
