<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes">
<title>Generador de Puzzle del Amor üíñ</title>
<style>
body{
  margin:0;
  background:#ffe1ec;
  color:#333;
  font-family:"Poppins",sans-serif;
  padding:20px;
  display:flex;
  flex-direction:column;
  gap:15px;
  align-items:center;
  overflow:auto;
}
h1{
  color:#ff4081;
  text-shadow:0 0 10px #ff80ab,0 0 25px #ffcce0;
  text-align:center;
  font-size:1.9em;
  margin-top:5px;
}
input,textarea,button{
  width:100%;max-width:480px;
  padding:10px;
  border-radius:8px;
  border:1px solid #ff80ab;
  font-size:15px;
}
button{
  background:#ff4081;color:#fff;font-weight:bold;cursor:pointer;
  transition:0.2s;border:none;
}
button:hover{background:#ff80ab;}
#preview-container{
  flex:1;
  border:2px solid #ff80ab;
  border-radius:10px;
  overflow:hidden;
  margin-top:10px;
  width:100%;
  max-width:900px;
}
iframe{width:100%;height:640px;border:none;background:#fff;}
</style>
</head>
<body>

<h1>üíû Generador de Puzzle del Amor üíû</h1>
<p>Sube una foto, escribe tu mensaje y crea un puzzle rom√°ntico e interactivo üíò</p>

<input type="file" id="imgInput" accept="image/*">
<textarea id="mensaje" placeholder="Escribe tu mensaje final..."></textarea>

<div style="display:flex;gap:10px;flex-wrap:wrap;justify-content:center;">
  <button onclick="previewPuzzle()">üëÄ Previsualizar</button>
  <button onclick="descargarPuzzle()">üì• Descargar HTML</button>
</div>

<div id="preview-container"><iframe id="preview"></iframe></div>

<script>
let imageBase64 = null;

document.getElementById("imgInput").addEventListener("change", e=>{
  const file = e.target.files[0];
  if(!file) return;
  const reader = new FileReader();
  reader.onload = ev => imageBase64 = ev.target.result;
  reader.readAsDataURL(file);
});

function buildPuzzleHTML(img, msg){
return `<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Puzzle del Amor üíû</title>
<style>
html,body{
  margin:0;padding:0;height:100%;
  font-family:'Poppins',sans-serif;
  background:#ffd0e1;
  overflow:hidden;
}
.scene{
  position:fixed;inset:0;
  display:flex;flex-direction:column;align-items:center;justify-content:center;
  opacity:0;transition:opacity 1s ease;z-index:0;
}
.scene.active{opacity:1;z-index:10;}
h1{
  font-size:24px;margin:20px 0 10px 0;text-align:center;color:#fff;
  text-shadow:0 0 15px #ff66aa,0 0 25px #ff99cc;
}
#moveCounter{
  text-align:center;
  color:#000;
  font-size:16px;
  text-shadow:0 0 6px #ffb6c1;
  margin-bottom:10px;
}
#puzzle{
  position:relative;width:320px;height:320px;
  background:linear-gradient(145deg,#ffd9e9,#fff);
  border-radius:16px;box-shadow:inset 0 0 15px #ffcce0,0 8px 18px rgba(0,0,0,0.25);
  overflow:hidden;transition:box-shadow 1s ease, opacity 1s ease;
}
#puzzle.glow{box-shadow:0 0 50px 20px #ff66aa,inset 0 0 25px #ffe6f1;}
.piece{
  position:absolute;width:calc(100%/3 - 2px);height:calc(100%/3 - 2px);
  background-size:300% 300%;cursor:pointer;transition:transform 0.25s ease-out, box-shadow 0.2s ease;
  border-radius:10px;border:1px solid rgba(255,255,255,0.6);
  box-shadow:0 2px 5px rgba(0,0,0,0.25),inset 0 0 4px rgba(255,255,255,0.5);
}
.empty{background:none;border:none;box-shadow:none;}
#winMessage{
  position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);
  color:#fff;font-size:2em;font-weight:bold;text-shadow:0 0 10px #ff4081,0 0 20px #ff80ab;
  background:rgba(255,64,129,0.25);padding:15px 25px;border-radius:10px;opacity:0;
  transition:opacity 0.8s ease;text-align:center;z-index:5;
}
#winMessage.show{opacity:1;}
.heart{
  position:absolute;width:20px;height:20px;background:#ff5fa2;
  transform:rotate(45deg);opacity:0.8;border-radius:4px;
  animation:float 10s ease-in-out infinite;bottom:-40px;z-index:1;
}
.heart:before,.heart:after{content:'';position:absolute;width:20px;height:20px;background:inherit;border-radius:50%;}
.heart:before{left:-10px;} .heart:after{top:-10px;}
@keyframes float{
  0%{transform:translateY(0) rotate(45deg) scale(1);}
  100%{transform:translateY(-850px) rotate(45deg) scale(1.3);opacity:0;}
}

/* escena regalo */
#final{background:rgba(0,0,0,0.7);}
#final img{width:90%;max-width:380px;border-radius:16px;box-shadow:0 0 25px #fff3;z-index:3;}
#final h2{color:#fff;text-shadow:0 0 20px #ff77aa;font-size:2em;margin-top:20px;text-align:center;z-index:3;}
#giftBtn{margin-top:25px;background:#ff5fa2;color:#fff;font-size:1.1em;padding:10px 20px;border:none;border-radius:8px;cursor:pointer;font-weight:bold;box-shadow:0 0 15px #ff9acb;animation:heartbeat 1.5s infinite ease-in-out;z-index:3;}
@keyframes heartbeat{0%,100%{transform:scale(1);}50%{transform:scale(1.1);}}

/* ü•ö huevo */
#eggScene {
  background: radial-gradient(circle at bottom, #ffb6c1, #ff80ab);
  color: #fff;
  text-shadow: 0 0 15px #ff4081;
  transform: scale(0.9);
  transition: all 1s ease;
}
#eggScene.show {
  transform: scale(1);
  opacity: 1;
}
#egg {
  width: 130px;
  height: 180px;
  background: radial-gradient(ellipse at 50% 30%, #fff 0%, #ffd9e9 60%, #ff80ab 100%);
  border-radius: 50% 50% 48% 48% / 60% 60% 40% 40%;
  box-shadow: 0 0 25px #ff8dc7, inset 0 -8px 15px rgba(255, 255, 255, 0.6);
  cursor: pointer;
  animation: pulse 3s infinite ease-in-out;
  position: relative;
  overflow: hidden;
}
@keyframes pulse {
  0%,100% { transform: scale(1); }
  50% { transform: scale(1.03); }
}
#egg.crack {
  animation: shake 0.6s ease, fadeOut 1.2s ease forwards;
  position: relative;
}
#egg::after {
  content: '';
  position: absolute;
  top: 0; left: 0; right: 0; bottom: 0;
  background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="120" height="180"><path d="M60 10 L70 50 L50 90 L80 130 L40 170 L60 130 L50 90 L65 50 Z" fill="none" stroke="%23ff0077" stroke-width="3"/></svg>') center/contain no-repeat;
  opacity: 0;
}
#egg.crack::after {
  opacity: 1;
  animation: flash 1.1s ease;
}
@keyframes shake {
  0%,100% { transform: rotate(0); }
  20% { transform: rotate(3deg); }
  40% { transform: rotate(-3deg); }
  60% { transform: rotate(2deg); }
  80% { transform: rotate(-2deg); }
}
@keyframes fadeOut {
  to { opacity: 0; transform: scale(1.25); }
}
@keyframes flash {
  0% { opacity: 1; }
  100% { opacity: 0; }
}

/* escena final */
#finalScene{background:linear-gradient(180deg,#160018,#2b0030 60%,#0a0010);}
#finalMessage{color:#fff;text-shadow:0 0 25px #ff4d88;font-size:2em;text-align:center;white-space:pre-line;z-index:3;margin-bottom:20px;}
#finalPhoto{opacity:0;width:85%;max-width:420px;border-radius:18px;box-shadow:0 0 30px #ff9acb77;transition:opacity 1.2s ease, transform 1.2s ease;transform:scale(1.1);z-index:3;}
#finalPhoto.show{opacity:1;transform:scale(1);}
#restartBtn{opacity:0;margin-top:25px;background:#ff4081;color:#fff;border:none;border-radius:8px;padding:10px 20px;font-weight:bold;box-shadow:0 0 15px #ff80ab;cursor:pointer;font-size:1.1em;transition:opacity 1s ease;z-index:3;}
#restartBtn.show{opacity:1;animation:pulseGlow 2s infinite ease-in-out;}
@keyframes pulseGlow{0%,100%{box-shadow:0 0 15px #ff80ab;}50%{box-shadow:0 0 25px #ffb3d1;}}
</style>
</head>
<body>

<div id="scene1" class="scene active">
  <h1>üíñ Arma el puzzle üíñ</h1>
  <div id="moveCounter">Movimientos: 0</div>
  <div id="puzzle"></div>
  <div id="winMessage"></div>
</div>

<div id="final" class="scene"><img src="${img}"><h2>${msg}</h2><button id="giftBtn">üéÅ Abre tu regalo</button></div>
<div id="eggScene" class="scene"><h2>üíû Quiebra el huevo üíû</h2><div id="egg"></div></div>
<div id="finalScene" class="scene"><div id="finalMessage"></div><img id="finalPhoto" src="${img}"><button id="restartBtn">üîÅ Reiniciar Puzzle</button></div>

<script>
const SIZE=3;
const imageURL='${img}';
const puzzle=document.getElementById('puzzle');
const moveCounter=document.getElementById('moveCounter');
const winMessage=document.getElementById('winMessage');
const final=document.getElementById('final');
const giftBtn=document.getElementById('giftBtn');
const eggScene=document.getElementById('eggScene');
const egg=document.getElementById('egg');
const finalScene=document.getElementById('finalScene');
const finalMessage=document.getElementById('finalMessage');
const finalPhoto=document.getElementById('finalPhoto');
const restartBtn=document.getElementById('restartBtn');
const total=SIZE*SIZE;
let tiles=[],order=[],bloqueado=false,movimientos=0;

function showScene(id){
  document.querySelectorAll('.scene').forEach(s=>s.classList.remove('active'));
  document.getElementById(id).classList.add('active');
}

for(let i=0;i<total-1;i++){
  const piece=document.createElement('div');
  piece.className='piece';
  const row=Math.floor(i/SIZE);
  const col=i%SIZE;
  piece.style.backgroundImage='url('+imageURL+')';
  piece.style.backgroundPosition=\`\${(col*100)/(SIZE-1)}% \${(row*100)/(SIZE-1)}%\`;
  piece.style.backgroundSize=\`\${SIZE*100}% \${SIZE*100}%\`;
  puzzle.appendChild(piece);
  tiles.push(piece);
  order.push(i);
}
const empty=document.createElement('div');
empty.className='piece empty';
puzzle.appendChild(empty);
tiles.push(empty);
order.push(total-1);
let emptyIndex=total-1;
shuffle();render();

function shuffle(){
  for(let i=0;i<60;i++){
    const idx=Math.floor(Math.random()*(total-1));
    move(idx,false);
  }
}
function render(){
  order.forEach((tileIndex,pos)=>{
    const r=Math.floor(pos/SIZE);
    const c=pos%SIZE;
    tiles[tileIndex].style.transform=\`translate(\${c*106.6}px,\${r*106.6}px)\`;
  });
}
puzzle.addEventListener('click',e=>{
  if(bloqueado) return;
  if(!e.target.classList.contains('piece')||e.target.classList.contains('empty'))return;
  const tileIdx=tiles.indexOf(e.target);
  const pos=order.indexOf(tileIdx);
  move(pos,true);
});
function move(pos,contar=true){
  const emptyPos=order.indexOf(emptyIndex);
  const r=Math.floor(pos/SIZE),c=pos%SIZE;
  const er=Math.floor(emptyPos/SIZE),ec=emptyPos%SIZE;
  if(Math.abs(r-er)+Math.abs(c-ec)===1){
    [order[pos],order[emptyPos]]=[order[emptyPos],order[pos]];
    render();
    if(contar){movimientos++;moveCounter.textContent="Movimientos: "+movimientos;}
    checkWin();
  }
}
function checkWin(){
  if(order.every((v,i)=>v===i)){
    bloqueado=true;
    moveCounter.textContent="Total de movimientos: "+movimientos;
    winMessage.textContent="¬°Puzzle completado en "+movimientos+" movimientos!";
    winMessage.classList.add('show');
    puzzle.classList.add('glow');
    generarCorazones(document.body);
    setTimeout(()=>{
      winMessage.style.display='none';
      showScene('final');
      generarCorazones(final);
    },2500);
  }
}
giftBtn.addEventListener('click',()=>{
  showScene('eggScene');
});
egg.addEventListener('click',()=>{
  if(egg.classList.contains('crack')) return;
  egg.classList.add('crack');
  generarCorazones(eggScene);
  setTimeout(()=>{eggScene.style.opacity='0';},700);
  setTimeout(()=>{
    showScene('finalScene');
    mostrarMensajeFinal("Cada pieza encaj√≥, igual que t√∫ en mi vida üíó");
    generarCorazones(finalScene);
  },1700);
});
function mostrarMensajeFinal(texto){
  finalMessage.textContent='';
  let i=0;
  const intervalo=setInterval(()=>{
    finalMessage.textContent+=texto.charAt(i);
    i++;
    if(i>=texto.length){
      clearInterval(intervalo);
      setTimeout(()=>{
        finalPhoto.classList.add('show');
        setTimeout(()=>restartBtn.classList.add('show'),1000);
      },500);
    }
  },70);
}
function generarCorazones(parent){
  for(let i=0;i<40;i++){
    const heart=document.createElement('div');
    heart.className='heart';
    const colores=['#ff4d6d','#ff66b2','#b300ff','#ff1493'];
    heart.style.background=colores[Math.floor(Math.random()*colores.length)];
    heart.style.left=Math.random()*100+'%';
    heart.style.animationDelay=Math.random()*10+'s';
    heart.style.animationDuration=(8+Math.random()*5)+'s';
    parent.appendChild(heart);
    setTimeout(()=>heart.remove(),15000);
  }
}
restartBtn.addEventListener('click',()=>location.reload());
<\/script>
</body>
</html>`;
}

function previewPuzzle(){
  if(!imageBase64){alert("Por favor sube una imagen.");return;}
  const msg=document.getElementById("mensaje").value||"Te amo üíñ";
  const html=buildPuzzleHTML(imageBase64,msg);
  document.getElementById("preview").srcdoc=html;
}

function descargarPuzzle(){
  if(!imageBase64){alert("Primero sube una imagen y genera la vista previa.");return;}
  const msg=document.getElementById("mensaje").value||"Te amo üíñ";
  const html=buildPuzzleHTML(imageBase64,msg);
  const blob=new Blob([html],{type:"text/html"});
  const a=document.createElement("a");
  a.href=URL.createObjectURL(blob);
  a.download="Puzzle-del-Amor.html";
  a.click();
}
</script>
</body>
</html>
